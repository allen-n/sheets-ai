<script>
  // Initialize the SheetsAI namespace
  window.SheetsAI = window.SheetsAI || {};

  /**
   * Shows a toast notification
   * @param {string} message - The message to display
   * @param {string} type - The type of toast (success, error, info)
   * @param {number} duration - Duration in milliseconds
   */
  SheetsAI.showToast = function (message, type = 'success', duration = 3000) {
    // Create toast container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'toast-container';
      document.body.appendChild(container);
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    // Add message and close button
    toast.innerHTML = `
      ${message}
      <button class="toast-close" onclick="this.parentNode.remove()">&times;</button>
    `;

    // Add to container
    container.appendChild(toast);

    // Remove after duration
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.add('fade-out');
        toast.addEventListener('animationend', () => {
          if (toast.parentNode) {
            toast.remove();
          }
        });
      }
    }, duration);
  };

  /**
   * Handles loading state for buttons
   * @param {HTMLElement} button - The button element
   * @param {boolean} isLoading - Whether the button is in loading state
   * @param {string} originalText - The original button text
   */
  SheetsAI.setButtonLoading = function (button, isLoading, originalText) {
    if (isLoading) {
      button.disabled = true;
      button.classList.add('loading');
      button.setAttribute('data-original-text', button.textContent);
      button.textContent = '';
    } else {
      button.disabled = false;
      button.classList.remove('loading');
      button.textContent =
        originalText || button.getAttribute('data-original-text') || 'Button';
    }
  };

  /**
   * Wrapper for google.script.run to handle errors and loading states consistently
   * @param {string} functionName - The server function name to call
   * @param {Object} options - Options for the call
   * @returns {Object} - The function to call with arguments
   */
  SheetsAI.callServer = function (functionName, options = {}) {
    const { loadingElement, onSuccess, onFailure } = options;

    if (loadingElement) {
      SheetsAI.setButtonLoading(loadingElement, true);
    }

    let runner = google.script.run;

    if (typeof onSuccess === 'function') {
      runner = runner.withSuccessHandler(function (result) {
        if (loadingElement) {
          SheetsAI.setButtonLoading(loadingElement, false);
        }
        onSuccess(result);
      });
    }

    if (typeof onFailure === 'function') {
      runner = runner.withFailureHandler(function (error) {
        if (loadingElement) {
          SheetsAI.setButtonLoading(loadingElement, false);
        }
        console.error('Error calling server function:', error);
        SheetsAI.showToast('An error occurred', 'error');
        onFailure(error);
      });
    } else {
      runner = runner.withFailureHandler(function (error) {
        if (loadingElement) {
          SheetsAI.setButtonLoading(loadingElement, false);
        }
        console.error('Error calling server function:', error);
        SheetsAI.showToast('An error occurred', 'error');
      });
    }

    // Return a function that takes arguments and calls the server function
    return function () {
      const args = Array.from(arguments);
      return runner[functionName].apply(runner, args);
    };
  };

  /**
   * Copies code text to clipboard
   * @param {string} codeId - The ID of the code element
   */
  SheetsAI.copyToClipboard = function (codeId) {
    const codeText = document.getElementById(codeId).innerText.trim();
    navigator.clipboard
      .writeText(codeText)
      .then(() => {
        const notificationId = 'copy-notification-' + codeId.split('-').pop();
        const notification = document.getElementById(notificationId);
        if (notification) {
          notification.style.display = 'block';
          setTimeout(() => {
            notification.style.display = 'none';
          }, 3000); // Auto-hide after 3 seconds
        } else {
          SheetsAI.showToast('Copied to clipboard', 'success');
        }
      })
      .catch((err) => {
        console.error('Failed to copy: ', err);
        SheetsAI.showToast('Failed to copy to clipboard', 'error');
      });
  };

  /**
   * Initialize UI components when DOM is ready
   */
  document.addEventListener('DOMContentLoaded', function () {
    // Add toast container
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container';
    document.body.appendChild(toastContainer);
  });
</script>
