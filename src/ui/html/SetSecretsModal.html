<!DOCTYPE html>
<html lang="en">
  <title>Set OpenAI API Key</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
    charset="UTF-8"
  />

  <head>
    <base target="_top" />
    <style>
      .modal-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .input-field {
        margin: 10px 0;
      }

      .btn {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="modal-container">
      <h3>OpenAI API Key</h3>
      <p>Current Key: <span id="current-key">Loading...</span></p>
      <div class="input-field">
        <input
          type="password"
          id="openai-key"
          placeholder="Enter OpenAI API Key"
          style="width: 250px"
        />
      </div>
      <button class="btn" onclick="saveKey()">Save</button>
    </div>

    <script>
      // Fetch and display the current OpenAI Key when the modal loads
      google.script.run
        .withSuccessHandler(function (storedKey) {
          document.getElementById('current-key').textContent =
            storedKey || 'No key set';
        })
        .getStoredOpenAIKey();

      // Save the new key to the properties service
      function saveKey() {
        try {
          const key = document.getElementById('openai-key').value;
          if (key) {
            google.script.run
              .withSuccessHandler(function (response) {
                alert(response);
                google.script.host.close(); // Close the modal after saving
              })
              .saveApiKey(key);
          } else {
            alert('Please enter a valid API key.');
          }
        } catch (error) {
          alert(
            'An error occurred. Please try again.\n\nError: ' + String(error)
          );
        }
      }
    </script>
  </body>
</html>
